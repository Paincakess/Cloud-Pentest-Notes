# Organization Hierarchy
![6b802724201789705168a437cdd86fb4.png](_resources/6b802724201789705168a437cdd86fb4.png)
# Azure AD
**Azure Active Directory (Azure AD)** is a service offered by Microsoft that provides identity and access management for an organization. It helps organizations securely manage their users, resources and applications. It provides features such as single sign-on (SSO), multi-factor authentication (MFA), and access control to help secure access to company resources. Simply put, it's a way for companies to manage and protect their online assets.
![37062b30f85c080e8f9dcd029c87b1f1.png](_resources/37062b30f85c080e8f9dcd029c87b1f1.png)
Azure AD is a service from Microsoft that helps you manage the identities of people in your company. It is a part of Azure, which is Microsoft's cloud platform. Azure AD is not the same as Windows Active Directory and works differently. 
Despite the misleading name, Azure AD is not Active Directory in the cloud. However, a parallel between the two solutions can be established:
![b4bd693d8d46fda895fcc7aa83c45241.png](_resources/b4bd693d8d46fda895fcc7aa83c45241.png)

## Integrating Azure AD to Windows AD
![c4551e5ff65f6dfe49d1e039f7eb8bab.png](_resources/c4551e5ff65f6dfe49d1e039f7eb8bab.png)
There are three ways to intgerate Azure AD and Windows AD, which are:
1. **Password Hash Synchronization**: The password hashes of the users in the on-premises AD are securely synced to Azure AD. This enables users to log in to both on-premises and cloud-based resources using the same credentials, providing a single sign-on (SSO) experience. Password Hash Synchronization is a feature of Azure AD Connect.
2. **Azure Active Directory Federation Services (ADFS)**: It is a way to manage user identities and access to resources in a secure and centralized manner. It enables users to log in to all their resources, including on-premises and cloud-based ones, using a single set of credentials. Azure ADFS also provides **additional security features**, such as MFA, to ensure that only authorized users have access to sensitive resources.
3. **Pass through Authentication**: It is a way to let users log in to cloud-based resources using the same username and password they use for their on-premises resources. The authentication request is securely passed from the cloud to the on-premises AD, where the user's credentials are verified. This enables organizations to continue using their existing on-premises AD infrastructure for authentication, while taking advantage of the benefits of cloud-based resources.

Azure AD Connect has to be installed on a server from the Active Directory forest. Password hashes of Active Directory users do not transit over the network. A hash of each password hash is being sent instead.

Two accounts are automatically created by Azure AD Connect:

- `MSOL_deeb213ff4bb` in the Active Directory.
- `Sync_SYNC01_deeb213ff4bb` in Azure AD.

**SYNC01** being the hostname of the on-premises server where Azure AD Connect is installed and **deeb213ff4bb**, an id, which changes for each environment.

# Principals
- **Users:** A regular person with credentials to access
- **Service Principals**: Applications or services that run in Azure and access resources on behalf of a user or another application. This access is restricted by the roles assigned to the service principal, giving you control over which resources can be accessed and at which level. When creating a service principal you can choose between **password authentication** or **certificate authentication**
	- Password Authenticaion: Password is only generated once, and it cannot be accessed again.
	- Certificate Authenticaion: Make sure the application will have access over the private key.
- **Group Accounts**: Collections of users or service principals that can be managed as a single entity. **Permissions** granted to groups are inherited by its members.
- **Managed Identity**: Managed identities provide an automatically managed identity in Azure Active Directory for applications to use when connecting to resources that support Azure Active Directory (Azure AD) authentication.

# Roles
Roles are assigned to principals on a scope: `principal -[HAS ROLE]->(scope)`
**Azure Active Directory (Azure AD) roles** and **Azure Roles** are two different types of roles in the **Azure platform** that are used for different purposes.

## Azure AD Roles
Azure AD roles are used to manage and control access to Azure AD resources. They provide predefined sets of permissions for specific tasks, such as creating and managing users, resetting passwords, and managing applications.
Here a list with all the [Azure built-in roles](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).

## Azure Roles
Azure Roles are used to manage and control access to Azure resources such as virtual machines, storage accounts, and databases. Azure roles provide a set of predefined permissions for specific tasks, such as creating and managing resources, accessing data, and controlling access to resources.
	Here a list with all the [Azure AD built-in roles](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

In summary, Azure AD roles are used for managing and controlling access to Azure AD resources, while Azure roles are used for managing and controlling access to Azure resources. Both roles provide predefined sets of permissions to perform specific tasks, but they are used in different contexts.
There is **one exceptional role which was can be used on both of those services** which is **Global Administrator Role**.

# Azure AD Security 
Azure AD by default has basic security features such as locking out an account after certain threshold of failed login attempts. However, more advanced security features are also available, depending on the subscribed license.
With Premium license, other additonal security features can be implemented such as **Conditional Access Policies** and **Identity Protection**

## Conditional Access Policies
![2a75c579e435b3423b1d89abd60e9ffe.png](_resources/2a75c579e435b3423b1d89abd60e9ffe.png)

It allows administrators to enforce specific access restrictions for their organization's resources. These policies help ensure secure access by granting or denying access based on a set of conditions that include user identity, device state, location, and risk level. 
Following criteria can be used as signals,
- User or group membership.
- IP location information.
- Device used.
- Application.
- Real-time and calculated risk detection (part of Azure AD Identity Protection feature, only for P2 licenses).
- Microsoft Cloud App Security (MCAS).

## Identity Protection
It is a security feature in Azure Active Directory that helps detect and prevent potential security threats to identities. It uses advanced machine learning algorithms and global threat intelligence to identify potential security issues, such as compromised credentials and sign-in risk, and provides administrators with notifications and recommended remediation actions.
For example, a user can be identified as risky if he uses a password present in a leaked database.

# Azure Kill Chain
The kill chain consists of five different roles: **outsider**, **guest**, **insider**, **admin**, and **on-prem admin**. Typically, outsiders are aiming for guest, insider, or admin roles. Similarly, guests are aiming for insider or admin roles. Insiders can already do much harm, but to get “keys to the kingdom” they often are aiming for (cloud) admin role. This is same for the on-prem admin.
![16bd1e9933ce9bc08ad17d9530555899.png](_resources/16bd1e9933ce9bc08ad17d9530555899.png)

## Outsider
Outsider refers to an user who has no access to the tenant of the target organization. Outsider can be able to extract information from any tenant using publicly available APIs and DNS Queries Using `ADDInternal` Module in powershell. This module can be downloaded in **PowerShell** using the following command. `Install-Module AADInternals`.

For Brief Reconnaissance.
- `Invoke-AADIntReconAsOutsider -DomainName company.com | Format-Table`. 

For more information gathering as outsider, you can read this following [blog](https://aadinternals.com/post/just-looking/).

## Guest
A guest user refers to an external user (with guest access) who has limited access to the target tenant in Azure AD. Despite their restricted access, they can still gather a lot of information from the tenant using various Microsoft-provided APIs.
For More information gathering as guest, you can read this following [blog](https://aadinternals.com/post/quest_for_guest/).

## Insider (User)
*Wolf in sheep's clothing*
User refers to “normal” users of the tenant. They have read-only access to practically all information in AAD.
For More information gathering as user, you can read this following [blog](https://aadinternals.com/post/insider/).

## On-Prem Admin
On-prem admin refers to an administrator who is administering on-prem servers running **Azure AD Connect**, **Active Directory Federation Services (AD FS)**, or **Active Directory**.

On-prem admins doesn’t have **direct access to the cloud**, but they can dump Azure AD Connect credentials and gain admin rights to cloud. If organization is using identity federation, on-prem admin can export the token signing certificates and sign in as any user of the tenant and bypass MFA!
For More information gathering as user, you can read this following [blog](https://aadinternals.com/post/on-prem_admin/).	

## Global Admin
Global admin has an unlimited access to all settings in the tenant. As such, they can change security settings, access any data, and create back doors.
For More information gathering as user, you can read this following [blog](https://aadinternals.com/post/admin/).	

# References
- https://aadinternals.com/aadkillchain/
- https://www.synacktiv.com/en/publications/azure-ad-introduction-for-red-teamers.html




