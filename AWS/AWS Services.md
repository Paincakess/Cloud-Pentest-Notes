# Services
- [API Gateway](#api-gateway)
- [Athena](#athena)
- [DyanmoDB](#dynamodb)
- [EC2](#ec2)
- [Elastic Container Registry (ECR)](#elastic-container-registry-ecr)
- [Elastic Registry Services (ECS)](#elastic-container-service-ecs)
- [Identity and Access Management (IAM)](#identity-and-access-management-iam)
- [Lambda](#lambda)
- [Route53](#route53)
- [Simple Storage Service (S3)](#simple-storage-service-s3-bucket)


# API Gateway
Amazon API Gateway is a fully managed service that makes it easy for developers to create, publish, maintain, monitor, and secure APIs at any scale. APIs act as the "front door" for applications to access data, business logic, or functionality from your backend services.

## General Information

- List Accounts
    - `aws apigateway get-account`
- List domain names
    - `aws apigateway get-domain-names`
- Get Usage Plan
    - `aws apigateway get-usage-plans`
- Get VPC (Virtual Private Cloud) Link
    - `aws apigateway get-vpc-link`
- Get Client Certificates
    - `aws apigateway get-client-certificates`

## API Enumeration

- List REST APIs
    - `aws apigateway get-rest-apis`
- Get Stages of API
    - `aws apigateway get-stages --rest-api-id <id>`
- Get Resources of API
    - `aws apigateway get-resources --rest-api-id <id>`
- Get API resource action per HTTP Methods
    - `aws apigateway get-method --http-method <Method> --rest-api-id <id> --resource-id <resource_id>`
- Calling API
    - `https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>`
- Get API Authorizers
    - `aws apigateway get-authorizers --rest-api-id <id>`
- Get Models
    - `aws apigateway get-models --rest-api-id <id>`

## Other Informations

- Get API responses
    - `aws apigateway get-gateway-responses --rest-api-id <id>`
- Get request validators
    - `aws apigateway get-request-validators --rest-api-id <id>`
- Get Deployements
    - `aws apigateway get-deployments --rest-api-id <id>`

## Vulnerabilities

### IAM access to APIs

It's possible to protect APIs with IAM-based authentication, but bad configurations might make an API accessible to all authenticated AWS users.
You will note that an API is expecting an IAM authorised token because it will send the response.
`{"message":"Missing Authentication Token"}`

One easy way to generate the expected token by the application is to use the **Authorization** type **AWS Signature** inside **Postman**.
![89a63633b511db9300d5e7a0318bbae8.png](_resources/89a63633b511db9300d5e7a0318bbae8.png)

Set the `accessKey` and the `SecretKey` of the account you want to use and you can know authenticate against the API endpoint.
It will generate an Authorization header such as:

```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```

Note that in other cases the Authorizer might have been bad coded and just sending anything inside the Authorization header will allow to see the hidden content.

### Usage Plans DoS

In the Enumeration section you can see how to obtain the usage plan of the keys. If you have the key and it's limited to X usages per month, you could just use it and cause a DoS.
The API Key just need to be included inside a HTTP header called x-api-key

# Athena

**Amazon Athena** is a query service that allows you to analyze data in **Amazon S3** using SQL. It is a serverless service, meaning that you don't have to worry about setting up and maintaining infrastructure to run Athena. Instead, you can simply send your SQL queries to Athena and the service will execute them and return the results.
**Amazon Athena** supports the ability to query S3 data that is already encrypted and if configured to do so, Athena can also encrypt the results of the query which can then be stored in S3.

## Catalog Enumeration

- List catalogs
    - `aws athena list-data-catalogs`
- Get database Inside the catalogs
    - `aws athena list-databases --catalog-name <catalog-name>`
- Get Table's Metadata
    - `aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>`

## Queries

- List Query Execution
    - `aws athena list-query-executions`
- Get query and metadata
    - `aws athena get-query-execution --query-execution-id <id>`
- Rerun the Query and get result
    - `aws athena get-query-results --query-execution-id <id>`

## Workgroups and Prepared Statements

- List Work groups
    - `aws athena list-work-groups`
- List Prepared Statements
    - `aws athena list-prepared-statements --work-group <wg-name>`
- Get Detail about the prepared statement
    - `aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>`

## Run Query

- Start Query Execution
    - `aws athena start-query-execution --query-string <query>`

# DyanmoDB
Amazon DynamoDB is a fully managed, serverless, key-value NoSQL database designed to run high-performance applications at any scale.

## Table Enumeration

- List tables
    - `aws dynamodb list-tables`
- Get table's metadata
    - `aws dynamodb describe-table --table-name <table_name>`
- Check if point in time recovery is enabled
    - `aws dynamodb describe-continuous-backups --table-name <table_name>`
- Get 1 example of the indicated attribute to learn its type
    - `aws dynamodb scan --table products --projection-expression "attribute" --max-items 1`

## Reading Contents Inside the Table

- Get data Inside the Table
    - `aws dynamodb scan --table-name <table_name>`
- Querying with Table Example
    - `aws dynamodb query --table-name <table_name> --projection-expression "SongTitle" --key-condition-expression "Artist = :v1" --expression-attribute-values file://expression-attributes.json --return-consumed-capacity TOTAL`

## Writing Contents in Table

- Putting data in table (XSS)
    
    - `aws dynamodb put-item --table <table_name> --item file://add.json`
    - Json Example
    
    ```
    {
    "Id": {
      "S": "1000"
    },
    "Name": {
      "S":  "Marc"
    },
    "Description": {
       "S": "<script>alert(1)</script>"
    }
    }
    ```
    
- Updating data in table (XSS)
    
    - `aws dynamodb update-item --table <table_name> --key file://key.json --update-expression "SET Description = :value" --expression-attribute-values file://val.json`
    - `Key.json` file example
    
    ```
    {
    "Id": {
        "S": "1000"
    }
    }
    ```
    
    - `val.json` file example
    
    ```
    {
    ":value": {
        "S": "<script>alert(1)</script>"
    }
    }
    ```
    

## Backups

- List Backups
    - `aws dynamodb list-backups`
- Get details about the backup
    - `aws dynamodb describe-backup --backup-arn <arn>`
- Backup of table
    - `aws dynamodb describe-continuous-backups --table-name <table_name>`

## Global Tables

- List global Tables
    - `aws dynamodb list-global-tables`
- Get more details about global tables
    - `aws dynamodb describe-global-table --global-table-name <table_name>`

## Exports

- List Exports
    - `aws dynamodb list-exports`
- More details about the export
    - `aws dynamodb describe-export --export-arn <arn>`

## Endpoints

- Describe Endpoints
    - `aws dynamodb describe-endpoints`

## For GUI

There is a GUI for local Dynamo services like `DynamoDB Local`, `dynalite`, `localstack`, etc, that could be useful: [dynamodb-admin](https://github.com/aaronshaf/dynamodb-admin).

## Exploits

### SQL Injection

There are ways to access DynamoDB data with SQL syntax, therefore, typical SQL injections are also possible.

### NoSQL Injection

In DynamoDB different conditions can be used to retrieve data, like in a common NoSQL Injection if it's possible to chain more conditions to retrieve data you could obtain hidden data (or dump the whole table)

### Raw JSON Injection

DynamoDB accepts JSON objects to search for data inside the DB. If you find that you can write in the json object sent to search, you could make the DB dump, all the contents.

For example, injecting request like,
`'{"Id": {"ComparisonOperator": "EQ","AttributeValueList": [{"N": "' + user_input + '"}]}}'`

Attacker can inject something like this:
`1000"}],"ComparisonOperator": "GT","AttributeValueList": [{"N": "0`

*fix the "EQ" condition searching for the ID 1000 and then looking for all the data with a Id string greater and 0, which is all*

# EC2 
You can use Amazon EC2 to launch as many or as few virtual servers as you need, configure security and networking, and manage storage.

Interesting things to enumerate in EC2:
- Virtual Machines
    - SSH Keys
    - User Data
    - Snapshots
- Networking
    - Networks
    - Subnetworks
    - Public IPs
    - Open ports
- Integrated connections with other networks outside AWS


## Enumerate EC2 Instances

- Describe ec2 Instance
    - `aws ec2 describe-instance`
- Get status of running instances
    - `aws ec2 describe-instance-status`
- Get user data from each ec2 instances
    
    ```
    for instanceid in $(aws ec2 describe-instances | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
    aws ec2 describe-instance-attribute --instance-id "$instanceid" --attribute 	userData
    done
    ```
    
- List Instance Profile
    - `aws iam list-instances-profile`
- List Instance Profile according to role
    - `aws iam list-instance-profiles-for-role --role-name <name>`
- Get Tags
    - `aws ec2 describe-tags`
- Get volume
    - `aws ec2 describe-volume-status`
    - `aws ec2 describe-volumes`
- Get Snapshots
    - `aws ec2 describe-snapshots --owner-ids self`
- Scheduled instances
    - `aws ec2 describe-scheduled-instances`
- Get Custom Image
    - `aws ec2 describe-images --owners self`
- Get Elastic IPs
    - `aws ec2 describe-addresses`
- Get Security Groups
    - `aws ec2 describe-security-groups`

## Network

- VPN Gateways
    - `aws ec2 describe-vpn-connections`
    - `aws ec2 describe-vpn-connections`
- Get Dedicated Hosts
    - `aws ec2 describe-hosts`
- Get SSH Key pairs
    - `aws ec2 describe-key-pairs`
- Get Internet Gateways
    - `aws ec2 describe-internet-gateways`
- Get NAT gateway
    - `aws ec2 describe-nat-gateways`
- Get subnetworks
    - `aws ec2 describe-subnets`
- Get Network ACL
    - `aws ec2 describe-network-acls`
- Get Interfaces
    - `aws ec2 describe-network-interfaces`
- Get Route Tables
    - `aws ec2 describe-route-tables`

## VMs Upload/Download

- Get Conversion Tasks
    - `aws ec2 describe-conversion-tasks`
- Import Image
    - `aws ec2 describe-import-image-tasks`

## Vulnerabilties

### DNS Exfiltration

Even if you lock down an EC2 so no traffic can get out, it can still exfil via DNS.

- VPC Flow Logs will not record this.
- You have no access to AWS DNS logs.
- Disable this by setting "enableDnsSupport" to false with: `aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

### Network Persistence

If a defender finds that an EC2 instance was compromised he will probably try to isolate the network of the machine. He could do this with an explicit Deny NACL (but NACLs affect the entire subnet), or changing the security group not allowing any kind of inbound or outbound traffic.
If the attacker had an SSH connection with the machine the change of the security grup will kill this connection. However, if the attacker had a reverse shell originated from the machine, even if no inboud or outbound rule allows this connection, the connection won't be killed due to Security Group Connection Tracking.

# Elastic Container Registry (ECR)
ECR is a managed container image registry service. Customers can use the familiar Docker CLI, or their preferred client, to push, pull, and manage images.

## Private repositories

- The URI is what is used to reference the repository images while creating containers on ECS clusters. The URI is of the format `<account\_id>.dkr.ecr.<region>.amazonaws.com/<repo-name>`
- The Tag immutability column lists its status, if tag immutability is enabled it will prevent image pushes with pre-existing tags from overwriting the images.
- The Encryption type column lists the encryption properties of the repository, it shows the default encryption types such as AES-256, or has KMS enabled encryptions.
- The Pull through cache column lists its status, if Pull through cache status is Active it will cache repositories in an external public repository into your private repository.
- Specific IAM policies can be configured to grant different permissions.
- The scanning configuration allows to scan for vulnerabilities in the images stored inside the repo.

## Public repositories:

The URI has a unique default alias like in: `public.ecr.aws/p3q0v3y2/alpine`

## General Enumeration

- List Repositories
	- `aws ecr describe-repositories`
- List Registries
	- `aws ecr describe-registry`
- List images inside a Repo
	- `aws ecr list-images --repository-name <repo\_name>`
- Get details of the image
	- `aws ecr describe-images --repository-name <repo\_name>`
- Get Replication Status of the Image
	- `aws ecr describe-image-replication-status --repository-name <repo\_name> --image-id <image\_id>`
- Get the scan findings for the specific image
	- `aws ecr describe-image-scan-findings --repository-name <repo\_name> --image-id <image\_id>`
- Return the pull through cache rules for a registry or image
	- `aws ecr describe-pull-through-cache-rules --repository-name <repo\_name> --image-id <image\_id>`

## Docker Functions
- Docker Login
	- `aws ecr get-login-password --profile <profile\_name> --region <region> | docker login --username AWS --password-stdin <account\_id>.dkr.ecr.<region>.amazonaws.com`
- Download image
	- `docker pull <UserID>.dkr.ecr.us-east-1.amazonaws.com/<ECRName>:latest`
- Get Details about the downloaded image
	- `docker inspect sha256:079aee8a89950717cdccd15b8f17c80e9bc4421a855fcdc120e1c534e4c102e0`
- Upload image
	- `docker tag purplepanda:latest <account\_id>.dkr.ecr.<region>.amazonaws.com/purplepanda:latest`
- Push Image
	- `docker push <account\_id>.dkr.ecr.<region>.amazonaws.com/purplepanda:latest`

## Downloading without Docker
- List Digests
	- `aws ecr batch-get-image --repository-name level2 --registry-id 653711331788 --image-ids imageTag=latest | jq '.images[].imageManifest | fromjson'`
- Downlaod Digest
	- `aws ecr get-download-url-for-layer --repository-name level2 --registry-id 653711331788 --layer-digest "sha256:edfaad38ac10904ee76c81e343abf88f22e6cfc7413ab5a8e4aeffc6a7d9087a"`

# Elastic Container Service (ECS)
ECS provides a platform to host containerized applications in the cloud. ECS has two deployment methods, EC2 and Fargate.
ECS operates using the following three building blocks: **Clusters**, **Services**, and **Task Definitions**.

- **Clusters** are groups of containers that are running in the cloud.
- **Services** are responsible for running tasks inside of clusters. Inside a service definition you define the number of tasks to run as well as general networking information such as VPC’s, subnets, and security groups.
- **Task Definitions** are responsible for defining what containers will run and the various parameters that will be configured with the containers. These parameters include any references to secrets or environment variables the containers need to operate.

## Cluster Information

- List Clusters
    - `aws ecs list-clusters`
- Get Details about the cluster
    - `aws ecs describe-clusters --clusters <cluster>`

## Container Information

- List Container Instances inside the cluster
    - `aws ecs list-container-instances`
- Get dtails about the containers
    - `aws ecs describe-container-instances`

## Service Enumeration

- List Services
    - `aws ecs list-services --cluster <cluster>`
- Get details about the service
    - `aws ecs describe-services --cluster <cluster> --services <services>`
- Get Tasks Sets
    - `aws ecs describe-task-sets --cluster <cluster> --service <service>`

## Task Enumeration

- List Tasks
    - `aws ecs list-task-definition-families`
    - `aws ecs list-task-definitions`
- Lists task inside the cluster
    - `aws ecs list-tasks --cluster <cluster>`
- Get task details
    - `aws ecs describe-tasks --cluster <cluster> --tasks <tasks>`
- Look for env vars and secrets used from the task definition
    - `aws ecs describe-task-definition --task-definition <TASK_NAME>:<VERSION>`

## Vulnerabilities

### Sensitive Data In Task Definitions

Task definitions are responsible for configuring the actual containers that will be running in ECS. Since task definitions define how containers will run, a plethora of information can be found within.
**Pacu** tool can enumerate ECS (list-clusters, list-container-instances, list-services, list-task-definitions), it can also dump task definitions.

# Identity and Access Management (IAM)
**Main Permissions needed for Enumeration**
- `iam:ListPolicies, iam:GetPolicy and iam:GetPolicyVersion`
- `iam:ListRoles`
- `iam:ListUsers`
- `iam:ListGroups`
- `iam:ListGroupsForUser`
- `iam:ListAttachedUserPolicies`
- `iam:ListAttachedRolePolicies`
- `iam:ListAttachedGroupPolicies`
- `iam:ListUserPolicies and iam:GetUserPolicy`
- `iam:ListGroupPolicies and iam:GetGroupPolicy`
- `iam:ListRolePolicies and iam:GetRolePolicy`

## All Details

Retrieves information about all IAM users, groups, roles and policies including their relationships to one another. Use this snapshot of the configuration of IAM permission in your account.

- `aws iam get-account-authorization-details`

## IAM Users

- List Users
    - `aws iam list-users`
- SSH public Keys
    - `aws iam list-ssh-public-keys`
- Get public key with metadata
    - `aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH`
- Get special permissions of the IAM user over specific services
    - `aws iam list-service-specific-credentials`
- Get metadata of user
    - `aws iam get-user --user-name <username>`
- List created access keys
    - `aws iam-list-access-keys`
- Get policies attached to the user
    - `aws iam list-attached-user-policies --user-name <username>`
- Get inline policies of the user
    - `aws iam list-user-policies --user-name <username>`
- Get inline policy details
    - `aws iam get-user-policy --user-name <username> --policy-name <policy_name>`

## IAM Groups

- List groups
    - `aws iam list-groups`
- Get groups of a user
    - `aws iam list-groups-for-user --user-name <username>`
- Get group name info
    - `aws iam get-group --group-name <name>`
- Get inline policies of the group
    -`aws iam list-group-policies --group-name <username>`
- Get an inline policy info
    - `aws iam get-group-policy --group-name <username> --policy-name <policy_name>`
- Get policies attached to the group
    - `aws iam list-attached-group-policies --group-name <group_name>`

## IAM Role

- List roles
    - `aws iam list-roles`
- Get Role Information
    - `aws iam get-role --role-name <role_name>`
- Get inline policies of a role
    - `aws iam list-role-policies --role-name <name>`
- Get inline policy details
    - `aws iam get-role-policy --role-name <name> --policy-name <policy_name>`
- Get policies attached to the role
    - `aws iam list-attached-role-policies --role-name <role-name>`

## IAM Policies

- List Policies
    - `aws iam list-policies [--only-attached] [--scope Local]`
- Get list of policies that give access to the user to the service.
    - `aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc>`
- Get policy content
    - `aws iam get-policy --policy-arn <policy_arn>`
- List Policy Versions
    - `aws iam list-policy-versions --policy-arn <arn>`
- Get Details about version of policies
    - `aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>`

## IAM Cognito Provider

- SAML Provider
    - `aws iam list-saml-providers`
    - `aws iam get-saml-provider --saml-provider-arn <ARN>`
- OPEN ID Connect
    - `aws iam list-open-id-connect-providers`
    - `aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>`

## Other Enumerations

- Get password policy
    - `aws iam get-account-password-policy`
- List MFA devices
    - `aws iam list-mfa-devices`
- Virtual MFA Devices
    - `aws iam list-virtual-mfa-devices`

## Useful Tools for IAM Enumeration

### Enumerate-iam

If interested in your own permissions but you don't have access to query IAM you could always brute-force them using
[**Download**](https://github.com/andresriancho/enumerate-iam)

```
git clone git@github.com:andresriancho/enumerate-iam.git
cd enumerate-iam/
pip install -r requirements.txt
```

- `./enumerate-iam.py --access-key <access_key> --secret-key <secret_key>`

### weridAAL

This tool will indicate and output the actions you can perform in the most common AWS services.
[**Download**](https://github.com/carnal0wnage/weirdAAL.git)

```
git clone https://github.com/carnal0wnage/weirdAAL.git
cd weirdAAL
python3 -m venv weirdAAL
source weirdAAL/bin/activate
pip3 install -r requirements.txt

# Create a .env file with aws credentials such as
[default]
aws_access_key_id = <insert key id>
aws_secret_access_key = <insert secret key>
```

- `python3 weirdAAL.py -m recon_all -t MyTarget`

## Post-Exploitation

### From IAM Creds to Console

if you have managed to obtain some IAM credentials you might be interested on accessing the web console. You can generate a web console link with [**aws_consoler**](https://github.com/NetSPI/aws_consoler) tool.

```
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...]
```

# Lambda
Lambda is a compute service that lets you run code without provisioning or managing servers.

## Account Settings

- Get Account Settings
    - `aws lambda get-account-settings`

## Functions and Config Enumeration

- List Functions
    - `aws lambda list-functions`
- Get Environment variables of function
    - `aws lambda list-functions | jq '.Functions[].Environment'`
- Get Function invoke configs
    - `aws lambda list-function-event-invoke-configs --function-name <function_name>`
- Get Function's URL Config
    - `aws lambda list-function-url-configs --function-name <function_name>`
- Get Configuration of a Function
    - `aws lambda get-function-configuration --function-name <function_name>`
- Get Function's Policy
    - `aws lambda get-policy --function-name <function_name>`
- List Function with its version
    - `aws lambda list-versions-by-function --function-name <function_name>`
- List Aliases of the Function
    - `aws lambda list-aliases --function-name <function_name>`
- Get More information about the Function and address to download the code
    - `aws lambda get-function --function-name <function_name>`
- Code to Download Function
    
    ```
    aws lambda get-function --function-name <function_name> --query 'Code.Location' --profile <profile>
    wget -O lambda-function.zip url-from-previous-query
    ```
    

## Layer Enumeration

- List layers
    - `aws lambda list-layers`
- List Version of the layer
    - `aws lambda list-layer-versions --layer-name <layer_name>`
- Enumerate layer's previous versions
    - `aws lambda get-layer-version --layer-name <layer_ name> --version-number <version>`

## Invoke Functions

- Invoke a Function
    - `aws lambda invoke --function-name <function_name> /tmp/out`

## Metadata Informations

- List Event Source Mapping
    - `aws lambda list-code-signing-configs`
- List Code Signings Configs
    - `aws lambda list-code-signing-configs`
- List Functions with specific code signing
    - `aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>`

## Vulnerabilties

### Version Backdoor + API Gateway

- Copy the original code of the Lambda
- Create a new version backdooring the original code (or just with malicious code). Publish and deploy that version to $LATEST
    - Call the API gateway related to the lambda to execute the code
- Create a new version with the original code, Publish and deploy that version to $LATEST.
    - This will hide the backdoored code in a previous version
- Go to the API Gateway and create a new POST method (or choose any other method) that will execute the backdoored version of the lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
    - Note the `final :1` of the arn indicating the version of the function
- Select the POST method created and in Actions select Deploy API
- Now, when you call the function via POST your Backdoor will be invoked

# Route53
Route 53 is a cloud **Domain Name System (DNS)** web service.
You can create `https`, `http` and `tcp health checks` for web pages via Route53.

## Enumeration

- List Hosted zones
    - `aws route53 list-hosted-zones`
- Get Host Zone Details
    - `aws route53 get-hosted-zone --id <hosted_zone_id>`
- Get Records of the Hosted Zone
    - `aws route53 list-resource-record-sets --hosted-zone-id <hosted_zone_id>`
- List Health Checks
    - `aws route53 list-health-checks`
- List Traffic Policies
    - `aws route53 list-traffic-policies`

# Simple Storage Service (S3) Bucket
Amazon S3 is a service that allows you store big amounts of data.

## Bucket Enumeration

- List s3 buckets
    - `aws s3 ls`
    - `aws s3api list-buckets`

## Bucket Content

- List bucket content
    - `aws s3 ls s3://<bucket_name>`
- Object version
    - `aws s3api list-objects-v2 --bucket <bucket-name>`
    - `aws s3api list-objects --bucket <bucket-name>`
    - `aws s3api list-object-versions --bucket <bucket-name>`
- List buckets without creds
    - `aws s3 ls s3://bucket-name --no-sign-request`
- Download file from Bucket
    - `aws s3 cp MyFolder s3://bucket-name --recursive`
- Delete Files from Bucket
    - `aws s3 rb s3://bucket-name –-force`
- Download a whole s3 bucket content
    - `aws s3 sync s3://<bucket>/ .`
- List the sizes of an S3 bucket and its contents
    - `aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"`

## Bucket Policy

- Update Bucket Policy
    - `aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>`
- JSON Policy example

```
{
  "Id": "Policy1568185116930",
  "Version": "2022-12-11",
  "Statement": [
  {
      "Sid": "Stmt1568109932241",
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:s3:::onion",
      "Principal": "*"
  },
  {
    "Sid": "Stmt1568185007451",
    "Action": [
      "s3:GetObject"
    ],
    "Effect": "Allow",
    "Resource": "arn:aws:s3:::onion/*",
    "Principal": "*"
  }
  ]
}
```

## Bucket ACL

- Get Bucket ACL
    - `aws s3api get-bucket-acl --bucket <bucket_name>`
- Update Bucket ACL
    - `aws s3api put-bucket-acl --bucket <bucket_name> --access-control-policy file://acl.json`
    - JSON ACL example

```
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
```
