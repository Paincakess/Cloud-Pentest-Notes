
# AWS Pentester/Red Team Methodology

When performing an audit or vulnerability assessment of an AWS environment, it is crucial to understand the services being used, what is publicly accessible, who has access to what resources, and the connections between internal and external services. From the perspective of a group attempting to infiltrate and compromise the environment, the initial step would be to acquire valid credentials. Here are some ways to find that,

- Leaks on Internet (OSINT)
- Social Engineering
- Password Leaks/Reuse
- Vulnerabilities in AWS-Hosted Applications
- 3rd parties breached
- Internal Employees
- Cognito Credentials

## Four main areas to concentrate on while performing Penetration Testing
- External Infrastructure of your AWS cloud
- Applications you are hosting/building on your platform
- Internal Infrastructure of your AWS cloud
- AWS configuration review

## AWS Pentesting Limitation (Legal Restriction)
- Amazon Web Services (AWS) servers
- Other companies’ physical hardware, facilities, or underlying infrastructure that belongs to AWS EC2
- Amazon’s Relational Database Service (RDS)
- Other suppliers manage security appliances

## AWS Services Enumeration, Exploitation and Privilege Escalation

The AWS platform offers a vast array of services, and this repo contains provides basic information, enumeration checklists, tips on privilege escalation, gaining persistence, and other techniques for post-exploitation on some of these services.
Manual Enumeration is not only the way to perform those pentest and audit, there are also variety of tools which can be used to automate the process, which will be discussed below shortly.

# Compromising the Organization

**Organization Hierarchy**
![8c4542467680b13bc2c57d11a88455af.png](_resources/8c4542467680b13bc2c57d11a88455af.png)

## Organization Enumeration

- Get Organization's Details
    - `aws organizations describe-organization`
- List Root Accounts
    - `aws organizations list-roots`
- List All Accounts
    - `aws organizations list-accounts`
- List Account from Parent Account
    - `aws organizations list-accounts-for-parent --parent-id <parent_id>`
- Get Organization's Unit
    - `aws organizations list-organizational-units-for-parent --parent-id <parent_id>`
- Get Basic Account Information
    - `aws iam get-account-summary`

## From the Root account

When the management account creates new accounts within the organization, a new role is automatically generated in the new account. This role, known as the `OrganizationAccountAccessRole`, grants the management account `AdministratorAccess` permissions to access the new account.

- Compromise the management account and find the ID of the children accounts and the names of the role (OrganizationAccountAccessRole by default) allowing the management account to access as admin.
    - To find children accounts go to the organizations section in the aws console or run `aws organizations list-accounts`
    - You cannot find the name of the roles directly, so check all the custom IAM policies and search any allowing `sts:AssumeRole` over the previously discovered children accounts.
- Compromise a principal in the management account with `sts:AssumeRole` permission over the role in the children accounts (even if the account is allowing anyone from the management account to impersonate, as its an external account, specific `sts:AssumeRole` permissions are necessary).

# Automated Tools

## Recon

- [AWS Recon](https://github.com/darkbitio/aws-recon) \- A multi-threaded AWS security-focused inventory collection tool. Install with following command: `gem install aws_recon`
    - `aws_recon --services <services> --regions <regions> --verbose`
- [CloudList](https://github.com/projectdiscovery/cloudlist) \- A multi-cloud tool for getting Assets (IP addresses and Host names) from Cloud Providers.
- [CloudMapper](https://github.com/duo-labs/cloudmapper) \- CloudMapper helps you analyze the AWS environments. It now contains much more functionality, including auditing for security issues.

```
# Create a config.json file with the aws info, like:
{
    "accounts": [
        {
            "default": true,
            "id": "<account id>",
            "name": "Test"
        }
    ],
    "cidrs":
    {
        "2.2.2.2/28": {"name": "NY Office"}
    }
}

# Enumeratation
python3 cloudmapper.py collect --profile Test
## Number of resources discovered
python3 cloudmapper.py stats --accounts Test

# Create HTML report
## In the report you will find all the info already
python3 cloudmapper.py report --accounts Test

# Identify potential issues 
python3 cloudmapper.py audit --accounts Test --json > audit.json
python3 cloudmapper.py audit --accounts Test --markdow > audit.md
python3 cloudmapper.py iam_report --accounts Test

# Identify admins
## The permissions search for are in https://github.com/duo-labs/cloudmapper/blob/4df9fd7303e0337ff16a08f5e58f1d46047c4a87/shared/iam_audit.py#L163-L175
python3 cloudmapper.py find_admins --accounts Test

# Identify unused elements
python3 cloudmapper.py find_unused --accounts Test

# Identify publivly exposed resources
python3 cloudmapper.py public --accounts Test

python cloudmapper.py prepare #Prepare webserver
python cloudmapper.py webserver #Show webserver
```

- [CartoGraphy](https://github.com/lyft/cartography) \- Cartography is a Python tool that consolidates infrastructure assets and the relationships between them in an intuitive graph view powered by a Neo4j database. To install: `pip install cartography`
    
    - `AWS_PROFILE=Test cartography --neo4j-uri bolt://127.0.0.1:7687 --neo4j-password-prompt --neo4j-user neo4j`
- [aws-inventory](https://github.com/nccgroup/aws-inventory) \- Starbase collects assets and relationships from services and systems including cloud infrastructure, SaaS applications, security controls, and more into an intuitive graph view backed by the Neo4j database.
    
- [aws\_public\_ips](https://github.com/arkadiyt/aws_public_ips) \- It's a tool to fetch all public IP addresses (both IPv4/IPv6) associated with an AWS account.
    

## Privilege Escalation and Exploiting

- [SkyArk](https://github.com/cyberark/SkyArk) \- Discover the most privileged users in the scanned AWS environment, including the AWS Shadow Admins. It uses powershell. You can find the definition of privileged policies in the function `Check-PrivilegedPolicy`.
- [Pacu](https://github.com/RhinoSecurityLabs/pacu) \- Pacu is an open-source AWS exploitation framework, designed for offensive security testing against cloud environments. It can enumerate, find miss-configurations and exploit them. Although `pacu` only checks your own privescs paths. For installation: `pip3 install pacu`

```
// Using Pacu Cli
pacu
> import_keys <profile_name> # import 1 profile from .aws/credentials
> import_keys --all # import all profiles
> list # list modules
> exec iam__enum_permissions # Get permissions
> exec iam__privesc_scan # List privileged permissions
```

- [PMapper](https://github.com/nccgroup/PMapper) \- PMapper is a tool that helps identify potential security risks in the way AWS Identity and Access Management (IAM) is configured for an AWS account or organization. It represents the relationships between IAM Users and Roles as a directed graph, which allows for analysis of privilege escalation and potential paths for unauthorized access to resources or actions in AWS. To install : `pip install principalmapper`

```
# Get data
pmapper --profile Test graph create
pmapper --profile Test graph display # Show basic info
# Generate graph
pmapper --profile Test visualize # Generate svg graph file (can also be png, dot and graphml)
pmapper --profile Test visualize --only-privesc # Only privesc permissions

# Generate analysis
pmapper --profile Test analysis
## Run queries
pmapper --profile Test query 'who can do iam:CreateUser'
pmapper --profile Test query 'preset privesc *' # Get privescs with admins

# Get organization hierarchy data
pmapper --profile Test orgs create
pmapper --profile Test orgs display
```

- [Cloudplaining](https://github.com/salesforce/cloudsplaining) \- Cloudsplaining is a tool that helps assess the security of AWS IAM by identifying instances where the principle of least privilege is not being followed. It generates a report that prioritizes identified risks and lists over-privileged customers, inline and AWS policies and which entities have access to them. Additionally, it checks for other types of potentially concerning permissions. It is **recommended** to use this tool for a comprehensive security assessment. To install: `pip install cloudsplaining`

```
# Download IAM policies to check
## Only the ones attached with the versions used
cloudsplaining download --profile Test

# Analyze the IAM policies
cloudsplaining scan --input-file /private/tmp/cloudsplaining/dev.json --output /tmp/files/
```

- [Cloudjack](https://github.com/prevade/cloudjack) \- CloudJack is a tool that analyzes AWS accounts for potential subdomain hijacking risks that may occur due to disconnected configurations of Route53 and CloudFront. It assesses the vulnerability of the account in that regard.
- [Dufflebag](https://github.com/bishopfox/dufflebag) \- Dufflebag is a tool that scans public Elastic Block Storage (EBS) snapshots for the presence of any secrets that may have been inadvertently included. It searches through the snapshots to identify and locate any sensitive information that may have been left behind.

## For Audit

- [CloudSpolit](https://github.com/aquasecurity/cloudsploit) \- CloudSploit by Aqua is an open-source tool that helps detect security vulnerabilities in cloud infrastructure accounts, such as Amazon Web Services (AWS), Microsoft Azure, Google Cloud Platform (GCP), Oracle Cloud Infrastructure (OCI) and GitHub. It is designed for various cloud infrastructure providers.
- [ScoutSuite](https://github.com/nccgroup/ScoutSuite) \- Scout Suite is an open source multi-cloud security-auditing tool, which enables security posture assessment of cloud environments. To install :
    - `virtualenv -p python3 venv`
    - `source venv/bin/activate`
    - `pip install scoutsuite`
    - Get Information : `scout aws -p Test`
- [Prowler](https://github.com/prowler-cloud/prowler) \- Prowler is an Open Source security tool to perform AWS security best practices assessments, audits, incident response, continuous monitoring, hardening and forensics readiness.

# Capturing AWS CLI Requests

- Set Proxy
    - `export HTTP_PROXY=http://localhost:8080`
    - `export HTTPS_PROXY=http://localhost:8080`
- Capture with burp nor verifying SSL
    - `aws --no-verify-ssl ...`
- Dowload brup cert and transform it to pem
    - `curl http://127.0.0.1:8080/cert --output Downloads/certificate.cer`
    - `openssl x509 -inform der -in Downloads/certificate.cer -out Downloads/certificate.pem`
- Indicate the ca certificate to trust
    - `export AWS_CA_BUNDLE=~/Downloads/certificate.pem`
- Run aws cli normally trusting burp certificate
    - `aws ...`
