---
title: 'EC2 '
updated: 2022-12-30 11:00:33Z
created: 2022-12-30 08:37:30Z
latitude: 27.71724530
longitude: 85.32396050
altitude: 0.0000
---

You can use Amazon EC2 to launch as many or as few virtual servers as you need, configure security and networking, and manage storage. 

Interesting things to enumerate in EC2:
- Virtual Machines
	- SSH Keys
	- User Data
	- Snapshots
- Networking
	- Networks
	- Subnetworks
	- Public IPs
	- Open ports
- Integrated connections with other networks outside AWS

## Enumerate EC2 Instances
- Describe ec2 Instance
	- `aws ec2 describe-instance`
- Get status of running instances 
	- `aws ec2 describe-instance-status`
-  Get user data from each ec2 instances
	```
	for instanceid in $(aws ec2 describe-instances | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
  	aws ec2 describe-instance-attribute --instance-id "$instanceid" --attribute 	userData
	done
	```
- List Instance Profile
	- `aws iam list-instances-profile`
-  List Instance Profile according to role
	- `aws iam list-instance-profiles-for-role --role-name <name>`
- Get Tags
	- `aws ec2 describe-tags`
- Get volume
	- `aws ec2 describe-volume-status`
	- `aws ec2 describe-volumes`
- Get Snapshots
	- `aws ec2 describe-snapshots --owner-ids self`
- Scheduled instances
	- `aws ec2 describe-scheduled-instances`
- Get Custom Image
	- `aws ec2 describe-images --owners self`
- Get Elastic IPs
	- `aws ec2 describe-addresses`
- Get Security Groups
	- `aws ec2 describe-security-groups`

## Network
- VPN Gateways
	- `aws ec2 describe-vpn-connections`
	- `aws ec2 describe-vpn-connections`
- Get Dedicated Hosts
	- `aws ec2 describe-hosts`
- Get SSH Key pairs
	- `aws ec2 describe-key-pairs`
- Get Internet Gateways
	- `aws ec2 describe-internet-gateways`
- Get NAT gateway
	- `aws ec2 describe-nat-gateways`
- Get subnetworks
	- `aws ec2 describe-subnets`
- Get Network ACL
	- `aws ec2 describe-network-acls`
- Get Interfaces
	- `aws ec2 describe-network-interfaces`
- Get Route Tables
	- `aws ec2 describe-route-tables`

## VMs Upload/Download
- Get Conversion Tasks
	- `aws ec2 describe-conversion-tasks`
- Import Image
	- `aws ec2 describe-import-image-tasks`

# Vulnerabilties
## DNS Exfiltration
Even if you lock down an EC2 so no traffic can get out, it can still exfil via DNS.
- VPC Flow Logs will not record this.
- You have no access to AWS DNS logs.
- Disable this by setting "enableDnsSupport" to false with: `aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

## Network Persistence
If a defender finds that an EC2 instance was compromised he will probably try to isolate the network of the machine. He could do this with an explicit Deny NACL (but NACLs affect the entire subnet), or changing the security group not allowing any kind of inbound or outbound traffic.
If the attacker had an SSH connection with the machine the change of the security grup will kill this connection. However, if the attacker had a reverse shell originated from the machine, even if no inboud or outbound rule allows this connection, the connection won't be killed due to Security Group Connection Tracking.


